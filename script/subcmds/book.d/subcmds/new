#!/usr/bin/env bash
#? Create a new book project
#? Usage: tb2 book new -b BOOKNAME
#? Opts:
#?   -b         BOOKNAME
#?   -q         exit if config variables are missing.
#? config dependencies: MDBOOK_SERIES_NAME, GH_OWNER_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH, PROJECT_NAME
set -euo pipefail

base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../../.."
source "$base_dir/utils.sh"

bookName=""
exit_missConf=false
while getopts "b:q" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  q)
    exit_missConf=true
    ;;
  \?)
    warn "Unknown option: -$OPTARG"
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    exit 1
    ;;
  esac
done
if [[ -z "${bookName}" ]]; then
  warn "Option -b requires an argument."
  info "Exit."
  exit 1
fi

log "Checking for config..."
checkConf "$exit_missConf" "MDBOOK_SERIES_NAME" "GH_OWNER_NAME" "MDBOOK_SRC_DIR" "TB2_OPERATION_BRANCH" "PROJECT_NAME"
seriesName=$("$base_dir/tb2" config get 'MDBOOK_SERIES_NAME')
name=$("$base_dir/tb2" config get 'GH_OWNER_NAME')
srcDir=$("$base_dir/tb2" config get 'MDBOOK_SRC_DIR')
branch=$("$base_dir/tb2" config get 'TB2_OPERATION_BRANCH')
projectName=$("$base_dir/tb2" config get 'PROJECT_NAME')
mustVar "$exit_missConf" "seriesName" "name" "srcDir" "branch" "projectName"
log "done."

info "Creating new book Issue: $bookName"
run gh_createIssue "$projectName" "Book: $bookName" "New book project '$bookName'"
log "done."
log "Issue created on GitHub successfully."

log "Checking for local directory..."

if [[ -d "$srcDir/$bookName" ]]; then
  warn "Directory '$srcDir/$bookName' already exists locally. Skipping mkdir."
else
  log "Creating local directory '$srcDir/$bookName'..."
  run mkdir "$srcDir/$bookName"
  ls "$srcDir/$bookName" >/dev/null 2>&1 || {
    error "Failed to create or access local directory '$srcDir/$bookName'."
    exit 1
  }
fi
log "done."
ans=$(ask "Do you want to commit&push the repository now draft branch? (y/n)")
if [[ "$ans" != "y" && "$ans" != "Y" ]]; then
  info "Exit."
  exit 0
fi
log "Using branch: $branch"
log "Checking if exist of branch name..."
if [[ "$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo)" != "$branch" ]]; then
  log "Branch '$branch' is not current branch."
  log "Checking for branch existence..."
  if git branch --list "$branch" >/dev/null 2>&1; then
    log "Branch '$branch' exists."
  else
    log "Branch '$branch' does not exist."
    ans=$(ask "Create branch[c] or Exit[e]?")
    if [[ "$ans" == "c" || "$ans" == "C" ]]; then
      run git switch -c "$branch"
      log "done."
    else
      info "Exit."
      exit 0
    fi
  fi
  log "Switching to branch '$branch'..."
  run git switch "$branch"
  log "done."
else
  log "Already on branch '$branch'."
  log "done."
fi

run git add "$srcDir/$bookName"
run git commit -m "Initial commit for book $bookName" || warn "commit failed"
run git push -u origin "$branch"
log "done."
info "New book project '$bookName' created successfully."
exit 0
