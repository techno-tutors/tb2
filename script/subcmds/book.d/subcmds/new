#!/usr/bin/env bash
#? Create a new book project
#? Usage: tb2 book new -b BOOKNAME
#? Opts:
#?   -b         BOOKNAME
#?   -q         exit if config variables are missing.
#? config dependencies: MDBOOK_SERIES_NAME, GH_OWNER_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH, PROJECT_NAME
set -euo pipefail


source "$ROOT/utils.sh"

bookName=""
exit_missConf=false
while getopts "b:q" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  q)
    exit_missConf=true
    ;;
  \?)
    warn "Unknown option: -$OPTARG"
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    exit 1
    ;;
  esac
done
if [[ -z "${bookName}" ]]; then
  warn "Option -b requires an argument."
  info "Exit."
  exit 1
fi

log "Checking for config..."
checkConf "$exit_missConf" "MDBOOK_SERIES_NAME" "GH_OWNER_NAME" "MDBOOK_SRC_DIR" "TB2_OPERATION_BRANCH" "PROJECT_NAME"
useConf MDBOOK_SERIES_NAME seriesName
useConf GH_OWNER_NAME name
useConf MDBOOK_SRC_DIR srcDir
useConf TB2_OPERATION_BRANCH branch
useConf PROJECT_NAME projectName
mustVar "$exit_missConf" "seriesName" "name" "srcDir" "branch" "projectName"
log "done."

info "Creating new book Issue: $bookName"
run gh_createIssue "$projectName" "Book: $bookName" "New book project '$bookName'"
log "done."
log "Issue created on GitHub successfully."

log "Checking for local directory..."

if [[ -d "$srcDir/$bookName" ]]; then
  warn "Directory '$srcDir/$bookName' already exists locally. Skipping mkdir."
else
  log "Creating local directory '$srcDir/$bookName'..."
  run mkdir "$srcDir/$bookName"
  ls "$srcDir/$bookName" >/dev/null 2>&1 || {
    error "Failed to create or access local directory '$srcDir/$bookName'."
    exit 1
  }
fi
log "done."
ans=$(ask "Do you want to commit&push the repository now draft branch? (y/n)")
if [[ "$ans" != "y" && "$ans" != "Y" ]]; then
  info "Exit."
  exit 0
fi
git_chkBranch "$branch"
run git add "$srcDir/$bookName"
run git commit -m "Initial commit for book $bookName"
run git push -u origin "$branch"
log "done."
info "New book project '$bookName' created successfully."
exit 0
