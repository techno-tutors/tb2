#!/usr/bin/env bash
#? Save a page (commit and push)
#? Usage: tb2 page save -c CHAPTERNAME -b BOOKNAME -p PAGENAME [-q]
#?   or: tb2 page save BOOKNAME/CHAPTERNAME/PAGENAME [-q]
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#?   -p         PAGENAME
#?   -q         Quiet mode (non-interactive)
#? config dependencies: MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH

set -euo pipefail

base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")"&&pwd)/../../.."
source "$base_dir/utils.sh"

bookName=""
chapterName=""
pageName=""
exit_missConf=false

# Handle positional argument format: BOOKNAME/CHAPTERNAME/PAGENAME
if [[ $# -ge 1 && "$1" == *"/"* && "$1" != -* ]]; then
  IFS='/' read -r bookName chapterName pageName <<< "$1"
  shift
fi

# Handle option format: -b BOOKNAME -c CHAPTERNAME -p PAGENAME [-q]
while getopts "b:c:p:q" opt; do
  case $opt in
    b)
      bookName="$OPTARG"
      ;;
    c)
      chapterName="$OPTARG"
      ;;
    p)
      pageName="$OPTARG"
      ;;
    q)
      exit_missConf=true
      ;;
    \?)
      warn "Unknown option: -$OPTARG"
      exit 1
      ;;
    :)
      warn "Option -$OPTARG requires an argument."
      exit 1
      ;;
  esac
done

if [[ -z "${bookName}" ]] || [[ -z "${chapterName}" ]] || [[ -z "${pageName}" ]]; then
  warn "Options -b BOOKNAME, -c CHAPTERNAME, and -p PAGENAME are all required."
  info "Exit."
  exit 1
fi


log "Checking for config..."
checkConf "$exit_missConf" "MDBOOK_SRC_DIR" "TB2_OPERATION_BRANCH"
srcDir=$("$base_dir/tb2" config get 'MDBOOK_SRC_DIR')
branch=$("$base_dir/tb2" config get 'TB2_OPERATION_BRANCH')
mustVar "$exit_missConf" "srcDir" "branch"
log "done."

pageFile="$srcDir/$bookName/$chapterName/$pageName.md"

info "Saving page: $pageName in chapter: $chapterName of book: $bookName"

log "Checking if page file exists..."
if [[ ! -f "$pageFile" ]]; then
  error "Page file '$pageFile' does not exist."
  info "Exit."
  exit 1
fi
log "done."

run "git add \"$pageFile\""
run "git commit -m \"Page: $pageName in $chapterName\""
log "done."

log "Pushing changes to '$branch'..."
run "git push"
log "done."

info "Page '$pageName' saved successfully."
exit 0
