#!/usr/bin/env bash
#? Create a new page
#? Usage: tb2 page new -c CHAPTERNAME -b BOOKNAME [-p PAGENAME] [-n chapterIssueNum]
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#?   -p         PAGENAME (optional, auto-numbered if not specified)
#?   -n         PARENT(chapter) ISSUE NUMBER
#? config dependencies: GH_OWNER_NAME, GH_REPO_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH

set -euo pipefail

. "$ROOT/utils.sh"

bookName=""
chapterName=""
pageName=""
chapterIssueNum=""

while getopts "b:c:p:n:" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  c)
    chapterName="$OPTARG"
    ;;
  p)
    pageName="$OPTARG"
    ;;
  n)
  	chapterIssueNum="$OPTARG"
  \?)
    warn "Unknown option: -$OPTARG"
    log "Exit."
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    log "Exit."
    exit 1
    ;;
  esac
done

if  [ -z "${bookName}" ] || [ -z "${chapterName}" ]; then
  warn "Both -b BOOKNAME and -c CHAPTERNAME are required."
  log "Exit."
  exit 1
fi
if [ -z "${chapterIssueNum}" ] && tb2_isManualMode; then
  warn "-n is required in manual mode."
  log "Exit."
  exit 1
fi

log "Checking for config..."

useConf GH_OWNER_NAME name
useConf GH_REPO_NAME repoName
useConf MDBOOK_SRC_DIR srcDir
useConf TB2_OPERATION_BRANCH branch

log "done."

chapterDir="$srcDir/$bookName/$chapterName"
log "Creating new page in chapter: $chapterName of book: $bookName"
log "Checking if chapter directory exists..."
if [ ! -d "$chapterDir" ]; then
  error "Chapter directory '$chapterDir' does not exist."
  log "Exit."
  exit 1
fi
log "done."

# Auto-generate page name if not specified
if [ -z "$pageName" ]; then
  log "Auto-generating page name..."
  pageNum=1
  while [ -f "$chapterDir/p$pageNum.md" ]; do
    pageNum=$((pageNum + 1))
  done
  pageName="p$pageNum"
  info "Generated page name: $pageName"
fi

pageFile="$chapterDir/$pageName.md"

log "Checking if page file already exists..."
if [ -f "$pageFile" ]; then
  warn "Page file '$pageFile' already exists. Skipping creation."
else
  log "Creating page file '$pageFile'..."
  run touch "$pageFile"
  log "done."
fi
log "Searching for parent chapter Issue..."
if [ -z "$chapterIssueNum" ]; then
  chapterIssueNum=$(gh issue list --repo "$name/$repoName" --search "title:\"Chapter: $chapterName\" \"($bookName)\"" --json number --jq '.[0].number' 2>/dev/null || echo "")
fi
if [ -z "$chapterIssueNum" ]; then
  warn "Could not find Chapter Issue for '$chapterName'. Continuing without link."
  pageIssueBody="Page '$pageName' in chapter '$chapterName' of book '$bookName'"
else
  log "Found Chapter Issue #$chapterIssueNum"
  pageIssueBody="Page '$pageName' in chapter '$chapterName' of book '$bookName'. Parent Issue: #$chapterIssueNum"
fi

log "Creating GitHub issue for page..."
run gh_createIssue "$name/$repoName" "Page: $pageName ($chapterName)" "$pageIssueBody"
log "done."

info "Page '$pageName' created successfully."
exit 0
