#!/usr/bin/env bash
#? Create a new page
#? Usage: tb2 page new -c CHAPTERNAME -b BOOKNAME [-p PAGENAME] [-q]
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#?   -p         PAGENAME (optional, auto-numbered if not specified)
#?   -q         Quiet mode (non-interactive)
#? config dependencies: GH_OWNER_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH, PROJECT_NAME

set -euo pipefail


source "$ROOT/utils.sh"

bookName=""
chapterName=""
pageName=""
exit_missConf=false

while getopts "b:c:p:q" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  c)
    chapterName="$OPTARG"
    ;;
  p)
    pageName="$OPTARG"
    ;;
  q)
    exit_missConf=true
    ;;
  \?)
    warn "Unknown option: -$OPTARG"
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    exit 1
    ;;
  esac
done

if [[ -z "${bookName}" ]] || [[ -z "${chapterName}" ]]; then
  warn "Both -b BOOKNAME and -c CHAPTERNAME are required."
  info "Exit."
  exit 1
fi

log "Checking for config..."
checkConf "$exit_missConf" "GH_OWNER_NAME" "MDBOOK_SRC_DIR" "TB2_OPERATION_BRANCH" "PROJECT_NAME"
useConf GH_OWNER_NAME name 
useConf MDBOOK_SRC_DIR srcDir 
useConf TB2_OPERATION_BRANCH branch 
useConf PROJECT_NAME projectName 
mustVar "$exit_missConf" "name" "srcDir" "branch" "projectName"
log "done."

chapterDir="$srcDir/$bookName/$chapterName"

info "Creating new page in chapter: $chapterName of book: $bookName"

log "Checking if chapter directory exists..."
if [[ ! -d "$chapterDir" ]]; then
  error "Chapter directory '$chapterDir' does not exist."
  info "Exit."
  exit 1
fi
log "done."

# Auto-generate page name if not specified
if [[ -z "$pageName" ]]; then
  log "Auto-generating page name..."
  pageNum=1
  while [[ -f "$chapterDir/p$pageNum.md" ]]; do
    ((pageNum++))
  done
  pageName="p$pageNum"
  log "Generated page name: $pageName"
fi

pageFile="$chapterDir/$pageName.md"

log "Checking if page file already exists..."
if [[ -f "$pageFile" ]]; then
  warn "Page file '$pageFile' already exists. Skipping creation."
else
  log "Creating page file '$pageFile'..."
  run touch "$pageFile"
  log "done."
fi

log "Searching for parent chapter Issue..."
chapterIssueNum=$(gh issue list --repo "$projectName" --search "title:\"Chapter: $chapterName\"" --json number --jq '.[0].number' 2>/dev/null || echo "")
if [[ -z "$chapterIssueNum" ]]; then
  warn "Could not find Chapter Issue for '$chapterName'. Continuing without link."
  pageIssueBody="Page '$pageName' in chapter '$chapterName' of book '$bookName'"
else
  log "Found Chapter Issue #$chapterIssueNum"
  pageIssueBody="Page '$pageName' in chapter '$chapterName' of book '$bookName'. Parent Issue: #$chapterIssueNum"
fi

log "Creating GitHub issue for page..."
run gh_createIssue "$projectName" "Page: $pageName ($chapterName)" "$pageIssueBody"
log "done."

info "Page '$pageName' created successfully."
exit 0
