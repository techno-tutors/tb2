#!/usr/bin/env bash
#? Create a new page
#? Usage: tb2 page new -c CHAPTERNAME -b BOOKNAME [-p PAGENAME] [-q]
#?   or: tb2 page new BOOKNAME/CHAPTERNAME/PAGENAME [-q]
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#?   -p         PAGENAME (optional, auto-numbered if not specified)
#?   -q         Quiet mode (non-interactive)
#? config dependencies: GH_OWNER_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH

set -euo pipefail

base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")"&&pwd)/../../.."
source "$base_dir/utils.sh"

bookName=""
chapterName=""
pageName=""
exit_missConf=false

# Handle positional argument format: BOOKNAME/CHAPTERNAME/PAGENAME
if [[ $# -ge 1 && "$1" == *"/"* && "$1" != -* ]]; then
  IFS='/' read -r bookName chapterName pageName <<< "$1"
  shift
fi

# Handle option format: -b BOOKNAME -c CHAPTERNAME [-p PAGENAME] [-q]
while getopts "b:c:p:q" opt; do
  case $opt in
    b)
      bookName="$OPTARG"
      ;;
    c)
      chapterName="$OPTARG"
      ;;
    p)
      pageName="$OPTARG"
      ;;
    q)
      exit_missConf=true
      ;;
    \?)
      warn "Unknown option: -$OPTARG"
      exit 1
      ;;
    :)
      warn "Option -$OPTARG requires an argument."
      exit 1
      ;;
  esac
done

if [[ -z "${bookName}" ]] || [[ -z "${chapterName}" ]]; then
  warn "Both -b BOOKNAME and -c CHAPTERNAME are required."
  info "Exit."
  exit 1
fi


log "Checking for config..."
checkConf "$exit_missConf" "GH_OWNER_NAME" "MDBOOK_SRC_DIR" "TB2_OPERATION_BRANCH"
name=$("$base_dir/tb2" config get 'GH_OWNER_NAME')
srcDir=$("$base_dir/tb2" config get 'MDBOOK_SRC_DIR')
branch=$("$base_dir/tb2" config get 'TB2_OPERATION_BRANCH')
mustVar "$exit_missConf" "name" "srcDir" "branch"
log "done."

chapterDir="$srcDir/$bookName/$chapterName"

info "Creating new page in chapter: $chapterName of book: $bookName"

log "Checking if chapter directory exists..."
if [[ ! -d "$chapterDir" ]]; then
  error "Chapter directory '$chapterDir' does not exist."
  info "Exit."
  exit 1
fi
log "done."

# Auto-generate page name if not specified
if [[ -z "$pageName" ]]; then
  log "Auto-generating page name..."
  pageNum=1
  while [[ -f "$chapterDir/p$pageNum.md" ]]; do
    ((pageNum++))
  done
  pageName="p$pageNum"
  log "Generated page name: $pageName"
fi

pageFile="$chapterDir/$pageName.md"

log "Checking if page file already exists..."
if [[ -f "$pageFile" ]]; then
  warn "Page file '$pageFile' already exists. Skipping creation."
else
  log "Creating page file '$pageFile'..."
  run "touch \"$pageFile\""
  log "done."
fi

info "Page '$pageName' created successfully."
exit 0
