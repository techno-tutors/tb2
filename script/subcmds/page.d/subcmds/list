#!/usr/bin/env bash
#? List pages in a chapter
#? Usage: tb2 page list -c CHAPTERNAME -b BOOKNAME
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#? config dependencies: MDBOOK_SRC_DIR

set -euo pipefail

base_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../../.."
source "$base_dir/utils.sh"

bookName=""
chapterName=""

while getopts "b:c:" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  c)
    chapterName="$OPTARG"
    ;;
  \?)
    warn "Unknown option: -$OPTARG"
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    exit 1
    ;;
  esac
done

if [[ -z "${bookName}" ]] || [[ -z "${chapterName}" ]]; then
  warn "Both -b BOOKNAME and -c CHAPTERNAME are required."
  info "Exit."
  exit 1
fi

log "Checking for config..."
checkConf true "MDBOOK_SRC_DIR" "PROJECT_NAME"
srcDir=$("$base_dir/tb2" config get 'MDBOOK_SRC_DIR')
projectName=$("$base_dir/tb2" config get 'PROJECT_NAME')
mustVar true "srcDir" "projectName"
log "done."

chapterDir="$srcDir/$bookName/$chapterName"
info "=Remote [GitHub Issues]="
log "=========================="
if gh_isManualMode; then
  info "Remote list is disabled in manual mode."
else
  run gh_findIssue "$projectName" "Page:"
fi
info "=Local [mdBook pages in $bookName/$chapterName]="
log "=========================================="

if [[ ! -d "$chapterDir" ]]; then
  warn "Chapter directory '$chapterDir' does not exist."
  exit 1
fi

run ls -1 "$chapterDir"/*.md 2>/dev/null | sed 's|.*/||;s|\.md$||' || echo 'No pages found.'
log "=========================================="
exit 0
