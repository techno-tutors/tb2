#!/usr/bin/env bash
#? Create a new chapter
#? Usage: tb2 chapter new -c CHAPTERNAME -b BOOKNAME [-q]
#? Opts:
#?   -b         BOOKNAME
#?   -c         CHAPTERNAME
#?   -q         Quiet mode (non-interactive)
#? config dependencies: GH_OWNER_NAME, MDBOOK_SRC_DIR, TB2_OPERATION_BRANCH, PROJECT_NAME

set -euo pipefail


source "$ROOT/utils.sh"

bookName=""
chapterName=""
exit_ifMissConf=false

while getopts "b:c:q" opt; do
  case $opt in
  b)
    bookName="$OPTARG"
    ;;
  c)
    chapterName="$OPTARG"
    ;;
  q)
    exit_ifMissConf=true
    ;;
  \?)
    warn "Unknown option: -$OPTARG"
    exit 1
    ;;
  :)
    warn "Option -$OPTARG requires an argument."
    exit 1
    ;;
  esac
done

if [[ -z "${bookName}" ]] || [[ -z "${chapterName}" ]]; then
  warn "Both -b BOOKNAME and -c CHAPTERNAME are required."
  info "Exit."
  exit 1
fi

log "Checking for config..."

useConf GH_OWNER_NAME name
useConf MDBOOK_SRC_DIR srcDir
useConf TB2_OPERATION_BRANCH branch
useConf PROJECT_NAME projectName


log "done."

chapterBranch="chapter/$chapterName"

info "Creating new chapter: $chapterName in book: $bookName"

log "Checking if book directory exists..."
if [[ ! -d "$srcDir/$bookName" ]]; then
  error "Book directory '$srcDir/$bookName' does not exist."
  info "Exit."
  exit 1
fi
log "done."

log "Searching for parent book Issue..."
bookIssueNum=$(gh issue list --repo "$projectName" --search "title:\"Book: $bookName\"" --json number --jq '.[0].number' 2>/dev/null || echo "")
if [[ -z "$bookIssueNum" ]]; then
  warn "Could not find Book Issue for '$bookName'. Continuing without link."
  bookIssueBody="Chapter '$chapterName' in book '$bookName'"
else
  log "Found Book Issue #$bookIssueNum"
  bookIssueBody="Chapter '$chapterName' in book '$bookName'. Parent Issue: #$bookIssueNum"
fi

git_chkBranch "$chapterBranch"

log "Checking for local directory..."
chapterDir="$srcDir/$bookName/$chapterName"
if [[ -d "$chapterDir" ]]; then
  warn "Directory '$chapterDir' already exists locally. Skipping mkdir."
else
  log "Creating local directory '$chapterDir'..."
  run mkdir -p "$chapterDir"
  log "done."
fi

log "Creating GitHub issue for chapter..."
run gh_createIssue "$projectName" "Chapter: $chapterName" "$bookIssueBody"
log "done."

ans=$(ask "Do you want to commit&push the repository now chapter branch? (y/n)")
if [[ "$ans" != "y" && "$ans" != "Y" ]]; then
  info "Exit."
  exit 0
fi

log "Committing and pushing changes..."
run git add "$chapterDir"
run git commit -m "Create chapter $chapterName"
run git push -u origin "$chapterBranch"
log "done."
info "New chapter '$chapterName' created successfully."
exit 0
