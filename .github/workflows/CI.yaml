name: CI

on:
  push:
    tags:
      - 'v*'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt devscripts bats
          pip install bashate

      - name: Run Checks
        run: |
          # 検査対象ファイルの抽出（scriptディレクトリ内）
          FILES=$(find script -type f -name "*.sh")
          if [ -z "$FILES" ]; then
            echo "No .sh files found."
            exit 0
          fi

          echo "Running shfmt..."
          shfmt -i 2 -ci -sr $FILES

          echo "Running bash -n..."
          for f in $FILES; do bash -n "$f"; done

          echo "Running shellcheck..."
          shellcheck --external-sources $FILES

          echo "Running bashate..."
          bashate -i E003,E006 --max-line-length 1000 $FILES

          echo "Running checkbashisms..."
          for f in $FILES; do checkbashisms --force "$f"; done

          echo "Checking strict mode (set -euo pipefail)..."
          for f in $FILES; do
            if ! grep -Eq '^[[:space:]]*set -euo pipefail' "$f"; then
              echo "Strict mode missing in $f"
              exit 1
            fi
          done

          echo "Checking shebang..."
          for f in $FILES; do
            read -r first_line < "$f"
            if [ "$first_line" != "#!/usr/bin/env bash" ]; then
              echo "Bad shebang in $f: $first_line"
              exit 1
            fi
          done

      - name: Run Bats tests
        run: |
          if ls test/*.bats 1> /dev/null 2>&1; then
            bats test
          else
            echo "No bats tests found."
          fi